<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>KOG Player Stats</title>
    <style>
      :root {
        color-scheme: dark;
        --bg-gradient: radial-gradient(circle at top, #151a33 0%, #05070e 55%, #010103 100%);
        --card-bg: rgba(12, 16, 34, 0.75);
        --card-border: rgba(82, 93, 150, 0.35);
        --glow: 0 24px 60px rgba(16, 26, 67, 0.55);
        --accent: #46c2ff;
        --accent-soft: rgba(70, 194, 255, 0.18);
        --text-primary: #f3f6ff;
        --text-muted: #9aa4c7;
        --divider: rgba(90, 105, 158, 0.35);
        --badge-bg: rgba(70, 194, 255, 0.12);
        --badge-text: #7fd6ff;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: "Inter", system-ui, -apple-system, Segoe UI, sans-serif;
        background: var(--bg-gradient);
        color: var(--text-primary);
        padding: clamp(1.6rem, 4vw, 3.5rem);
        display: flex;
        justify-content: center;
      }

      main {
        width: min(1100px, 100%);
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 28px;
        box-shadow: var(--glow);
        backdrop-filter: blur(20px);
        padding: clamp(1.6rem, 3vw, 3rem);
        position: relative;
        overflow: hidden;
      }

      main::before {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        background: radial-gradient(circle at 25% 15%, rgba(70, 194, 255, 0.22), transparent 55%),
          radial-gradient(circle at 80% 0%, rgba(125, 214, 255, 0.12), transparent 60%);
        filter: blur(0.5px);
      }

      header {
        position: relative;
        z-index: 1;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 1.5rem;
        margin-bottom: clamp(1.8rem, 3vw, 2.8rem);
      }

      .team-lockup {
        display: flex;
        align-items: center;
        gap: clamp(0.9rem, 2vw, 1.4rem);
      }

      .team-lockup__text {
        display: grid;
        gap: 0.45rem;
      }

      .team-logo {
        width: clamp(64px, 12vw, 92px);
        height: clamp(64px, 12vw, 92px);
        object-fit: cover;
        border-radius: 50%;
        border: 2px solid rgba(70, 194, 255, 0.35);
        box-shadow: 0 12px 28px rgba(16, 32, 72, 0.45);
        background: rgba(4, 6, 14, 0.6);
      }

      .team-lockup h1 {
        font-size: clamp(2.1rem, 4vw, 2.9rem);
        letter-spacing: 0.04em;
        text-transform: uppercase;
        margin: 0;
      }

      .team-lockup span {
        font-size: 0.95rem;
        text-transform: uppercase;
        letter-spacing: 0.4em;
        color: var(--text-muted);
      }

      .meta {
        display: flex;
        flex-wrap: wrap;
        gap: 0.7rem;
        z-index: 1;
      }

      .badge {
        padding: 0.45rem 0.85rem;
        border-radius: 999px;
        border: 1px solid var(--accent-soft);
        background: var(--badge-bg);
        color: var(--badge-text);
        font-size: 0.8rem;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        letter-spacing: 0.08em;
      }

      .badge strong {
        font-weight: 600;
        color: var(--text-primary);
      }

      .badge--hero {
        padding: 0.7rem 1.4rem;
        font-size: 1.05rem;
        letter-spacing: 0.06em;
        color: #12263e;
        background: linear-gradient(130deg, #f8d057, #ffd97a);
        border: none;
        box-shadow: 0 14px 32px rgba(255, 207, 87, 0.35);
      }

      .badge--hero strong {
        color: #10233b;
      }

      section {
        position: relative;
        z-index: 1;
      }

      .table-wrapper {
        overflow-x: auto;
        border-radius: 20px;
        border: 1px solid rgba(96, 108, 162, 0.25);
        background: rgba(7, 10, 22, 0.65);
        box-shadow: inset 0 1px 0 rgba(108, 124, 182, 0.25);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 720px;
      }

      thead {
        background: linear-gradient(95deg, rgba(70, 194, 255, 0.18), rgba(70, 194, 255, 0.05));
      }

      th,
      td {
        padding: 1rem 1.25rem;
        text-align: right;
        font-size: 0.92rem;
      }

      th {
        text-transform: uppercase;
        letter-spacing: 0.2em;
        font-size: 0.72rem;
        color: var(--text-muted);
        font-weight: 600;
      }

      th:first-child,
      td:first-child,
      th:nth-child(2),
      td:nth-child(2) {
        text-align: left;
      }

      tbody tr {
        border-bottom: 1px solid var(--divider);
        transition: background 180ms ease, transform 180ms ease;
        cursor: pointer;
      }

      tbody tr:last-child {
        border-bottom: none;
      }

      tbody tr:hover {
        background: rgba(70, 194, 255, 0.06);
        transform: translateY(-2px);
      }

      tbody td {
        color: var(--text-primary);
      }

      tbody td span {
        display: block;
        color: var(--text-muted);
        font-size: 0.78rem;
        letter-spacing: 0.02em;
      }

      .number {
        font-weight: 600;
        color: var(--accent);
      }

      .highlight {
        color: #f8d057;
        font-weight: 600;
        text-shadow: 0 0 16px rgba(255, 210, 95, 0.45);
      }

      .totals {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 1rem;
        margin-bottom: 1.8rem;
        position: relative;
        z-index: 1;
      }

      .totals-card {
        border: 1px solid rgba(96, 108, 162, 0.22);
        background: rgba(9, 12, 26, 0.65);
        border-radius: 18px;
        padding: 1rem 1.2rem;
        display: grid;
        gap: 0.35rem;
      }

      .totals-card.card-clickable {
        cursor: pointer;
        transition: transform 150ms ease, border 150ms ease;
      }

      .totals-card.card-clickable:hover {
        transform: translateY(-3px);
        border-color: rgba(125, 214, 255, 0.45);
      }

      .totals-card span {
        color: var(--text-muted);
        font-size: 0.8rem;
        letter-spacing: 0.16em;
        text-transform: uppercase;
      }

      .totals-card strong {
        font-size: 1.6rem;
        font-weight: 600;
        letter-spacing: 0.04em;
      }

      .totals-card p {
        margin: 0;
        color: var(--text-muted);
        font-size: 0.78rem;
        letter-spacing: 0.04em;
      }

      .schedule {
        margin-top: clamp(2.4rem, 6vw, 3.4rem);
        display: grid;
        gap: 1.6rem;
      }

      .schedule-title {
        margin: 0;
        font-size: clamp(1.2rem, 3vw, 1.5rem);
        letter-spacing: 0.26em;
        text-transform: uppercase;
        color: var(--text-muted);
      }

      .next-game-wrapper {
        display: none;
      }

      .next-game-wrapper.active {
        display: block;
      }

      .games-group {
        display: grid;
        gap: 0.85rem;
      }

      .games-group h3 {
        margin: 0;
        text-transform: uppercase;
        letter-spacing: 0.24em;
        font-size: 0.78rem;
        color: var(--text-muted);
      }

      .games-list {
        display: grid;
        gap: 0.8rem;
      }

      .game-card {
        border: 1px solid rgba(96, 108, 162, 0.24);
        background: rgba(7, 10, 22, 0.62);
        border-radius: 18px;
        padding: 1rem 1.2rem;
        display: grid;
        gap: 0.65rem;
        box-shadow: inset 0 1px 0 rgba(70, 194, 255, 0.12);
      }

      .game-card--next {
        border-color: rgba(125, 214, 255, 0.48);
        background: rgba(15, 32, 58, 0.78);
        box-shadow: 0 18px 44px rgba(24, 61, 123, 0.32);
      }

      .game-card__header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
      }

      .game-card__label {
        font-size: 0.78rem;
        letter-spacing: 0.24em;
        text-transform: uppercase;
        color: var(--badge-text);
      }

      .game-card__homeaway {
        font-size: 0.72rem;
        letter-spacing: 0.22em;
        text-transform: uppercase;
        padding: 0.32rem 0.95rem;
        border-radius: 999px;
        border: 1px solid rgba(96, 108, 162, 0.42);
        color: var(--text-muted);
      }

      .game-card__homeaway.is-home {
        border-color: rgba(125, 214, 255, 0.45);
        color: var(--accent);
      }

      .game-card__homeaway.is-away {
        border-color: rgba(255, 210, 95, 0.45);
        color: #ffd97a;
      }

      .game-card__opponent {
        font-size: clamp(1.15rem, 3vw, 1.35rem);
        font-weight: 600;
        letter-spacing: 0.04em;
      }

      .game-card__meta {
        font-size: 0.86rem;
        letter-spacing: 0.06em;
        color: var(--text-muted);
      }

      .game-card__score {
        display: inline-flex;
        align-items: baseline;
        gap: 0.45rem;
        font-size: clamp(1.6rem, 3vw, 1.9rem);
        font-weight: 600;
        letter-spacing: 0.08em;
      }

      .game-card__score-sep {
        font-size: 1rem;
        color: var(--text-muted);
      }

      .game-card__result {
        text-transform: uppercase;
        letter-spacing: 0.2em;
        font-size: 0.78rem;
      }

      .game-card__result--win {
        color: #7fd6ff;
      }

      .game-card__result--loss {
        color: #ff8c8c;
      }

      .game-card__result--draw {
        color: var(--text-muted);
      }

      .game-card__countdown {
        font-size: 0.84rem;
        letter-spacing: 0.08em;
        color: var(--badge-text);
      }

      .team-photo {
        margin-top: clamp(2.4rem, 6vw, 3.4rem);
        display: flex;
        justify-content: center;
      }

      .team-photo img {
        width: min(460px, 90%);
        border-radius: 22px;
        border: 2px solid rgba(70, 194, 255, 0.25);
        box-shadow: 0 20px 48px rgba(12, 26, 66, 0.45);
        object-fit: cover;
      }

      .links-card {
        margin-top: clamp(2rem, 5vw, 2.8rem);
        border: 1px solid rgba(96, 108, 162, 0.28);
        border-radius: 20px;
        background: rgba(6, 9, 20, 0.62);
        padding: clamp(1.2rem, 3vw, 1.8rem);
        display: grid;
        gap: 1rem;
      }

      .links-card h3 {
        margin: 0;
        text-transform: uppercase;
        letter-spacing: 0.28em;
        font-size: 0.78rem;
        color: var(--text-muted);
      }

      .links-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.8rem;
      }

      .links-list a {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.55rem 1rem;
        border-radius: 999px;
        border: 1px solid rgba(70, 194, 255, 0.26);
        color: var(--badge-text);
        text-decoration: none;
        letter-spacing: 0.08em;
        font-size: 0.82rem;
        transition: border 150ms ease, color 150ms ease, transform 150ms ease;
      }

      .links-list a:hover {
        border-color: rgba(125, 214, 255, 0.45);
        color: var(--accent);
        transform: translateY(-1px);
      }

      .no-data {
        margin-top: 1.6rem;
        padding: 1.1rem 1.3rem;
        border-radius: 14px;
        border: 1px dashed rgba(70, 194, 255, 0.42);
        background: rgba(4, 7, 18, 0.65);
        color: var(--badge-text);
        font-size: 0.88rem;
        display: none;
      }

      @media (max-width: 768px) {
        main {
          border-radius: 22px;
        }

        header {
          flex-direction: column;
          align-items: flex-start;
        }

        thead {
          position: sticky;
          top: 0;
        }
      }

      @media (max-width: 640px) {
        body {
          padding: 1.2rem;
        }

        th,
        td {
          padding: 0.7rem 0.85rem;
          font-size: 0.84rem;
        }

        th {
          font-size: 0.66rem;
          letter-spacing: 0.16em;
        }

        tbody td span {
          font-size: 0.7rem;
        }

        .badge {
          font-size: 0.7rem;
          letter-spacing: 0.06em;
        }
      }

      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(4, 6, 14, 0.75);
        backdrop-filter: blur(14px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 20;
        padding: 1.2rem;
      }

      .modal-overlay.visible {
        display: flex;
      }

      .modal-card {
        width: min(420px, 100%);
        background: rgba(8, 12, 26, 0.9);
        border: 1px solid rgba(108, 132, 205, 0.4);
        border-radius: 22px;
        padding: clamp(1.4rem, 4vw, 2rem);
        box-shadow: 0 22px 58px rgba(8, 12, 32, 0.55);
        display: grid;
        gap: 1rem;
      }

      .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
      }

      .modal-header h2 {
        margin: 0;
        font-size: clamp(1.4rem, 5vw, 1.9rem);
        letter-spacing: 0.05em;
      }

      .close-modal {
        appearance: none;
        border: 1px solid rgba(108, 132, 205, 0.35);
        background: rgba(10, 14, 31, 0.6);
        color: var(--text-muted);
        border-radius: 999px;
        padding: 0.45rem 0.95rem;
        font-size: 0.78rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        cursor: pointer;
        transition: background 150ms ease, color 150ms ease;
      }

      .close-modal:hover {
        background: rgba(78, 126, 255, 0.18);
        color: var(--text-primary);
      }

      .modal-badges {
        display: flex;
        flex-wrap: wrap;
        gap: 0.6rem;
      }

      .modal-stats {
        display: grid;
        gap: 0.9rem;
      }

      .stat-row {
        display: flex;
        justify-content: space-between;
        font-size: 1.02rem;
        letter-spacing: 0.02em;
      }

      .stat-row span:first-child {
        color: var(--text-muted);
        text-transform: uppercase;
        font-size: 0.78rem;
        letter-spacing: 0.18em;
      }

      .stat-row strong {
        font-size: 1.2rem;
      }

      .stat-row.interactive {
        cursor: pointer;
      }

      .stat-row.interactive:hover strong,
      .stat-row.interactive:hover span {
        color: var(--accent);
      }
    </style>
  </head>
  <body>
    <main>
      <header></header>

      <section class="totals" id="teamTotals"></section>

      <section>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>No.</th>
                <th>Player</th>
                <th>Games</th>
                <th>FT Made</th>
                <th>FG Made</th>
                <th>P/G</th>
                <th>Total Pts</th>
                <th>3PT Made</th>
                <th>Fouls</th>
              </tr>
            </thead>
            <tbody id="statsTable"></tbody>
          </table>
        </div>
        <div class="no-data" id="noDataMessage">
          No stats available yet. Check back after the next Kungsholmen OG game tip-off.
        </div>
      </section>

      <section class="schedule" id="scheduleSection" hidden>
        <h2 class="schedule-title">Season Schedule</h2>
        <div class="next-game-wrapper" id="nextGameWrapper"></div>
        <div class="games-group" id="playedGamesGroup">
          <h3>Games Played</h3>
          <div class="games-list" id="playedGamesList"></div>
        </div>
        <div class="games-group" id="upcomingGamesGroup">
          <h3>Upcoming Games</h3>
          <div class="games-list" id="upcomingGamesList"></div>
        </div>
      </section>

      <section class="team-photo">
        <img src="assets/team-photo.png" alt="Kungsholmen OG team photo" />
      </section>

      <section class="links-card" id="linksCard" hidden>
        <h3>Links</h3>
        <div class="links-list" id="linksList"></div>
      </section>
    </main>
    <div class="modal-overlay" id="playerModal" aria-hidden="true">
      <div class="modal-card" role="dialog" aria-modal="true">
        <div class="modal-header">
          <h2 id="modalPlayerName"></h2>
          <button class="close-modal" id="closeModal" type="button">Close</button>
        </div>
        <div class="modal-badges" id="modalBadges"></div>
        <div class="modal-stats" id="modalStats"></div>
      </div>
    </div>

    <script>
      const header = document.querySelector("header");
      const metaContainer = document.createElement("div");
      const scheduleSection = document.getElementById("scheduleSection");
      const nextGameWrapper = document.getElementById("nextGameWrapper");
      const playedGamesGroup = document.getElementById("playedGamesGroup");
      const playedGamesList = document.getElementById("playedGamesList");
      const upcomingGamesGroup = document.getElementById("upcomingGamesGroup");
      const upcomingGamesList = document.getElementById("upcomingGamesList");
      const linksCard = document.getElementById("linksCard");
      const linksList = document.getElementById("linksList");
      let playerStore = [];
      metaContainer.className = "meta";
      header.appendChild(
        (() => {
          const lockup = document.createElement("div");
          lockup.className = "team-lockup";
          lockup.innerHTML = `
            <img src="assets/team-logo.png" alt="Kungsholmen OG logo" class="team-logo" />
            <div class="team-lockup__text">
              <span>Season 2025</span>
              <h1>Kungsholmen OG</h1>
            </div>
          `;
          return lockup;
        })()
      );
      header.appendChild(metaContainer);

      const modalOverlay = document.getElementById("playerModal");
      const modalName = document.getElementById("modalPlayerName");
      const modalBadges = document.getElementById("modalBadges");
      const modalStats = document.getElementById("modalStats");
      const closeModalBtn = document.getElementById("closeModal");

      function createBadge(label, value, extraClass = "") {
        const badge = document.createElement("span");
        badge.className = extraClass ? `badge ${extraClass}` : "badge";
        badge.innerHTML = `<strong>${value}</strong>${label}`;
        return badge;
      }

      function formatDiff(diff) {
        if (diff > 0) return `+${diff}`;
        if (diff < 0) return `${diff}`;
        return `${diff}`;
      }

      const formatScoreLine = (record) => `${record.kogPoints}-${record.opponentPoints}`;

      function renderTotals(totals, gamesCount, playersTracked, teamRecords) {
        const cards = [
          { label: "Team Points", value: totals.totalPoints },
          { label: "Team Field Goals", value: totals.fieldGoals, metric: "fieldGoalsMade" },
          { label: "Team Free Throws", value: totals.freeThrows, metric: "freeThrowsMade" },
          { label: "Team 3PT", value: totals.threePointers, metric: "threePointsMade" },
          { label: "Games Logged", value: gamesCount },
          { label: "Players Tracked", value: playersTracked }
        ];

        if (teamRecords?.highestScore) {
          cards.push({
            label: "Highest Score",
            value: teamRecords.highestScore.kogPoints,
            subtitle: `vs ${teamRecords.highestScore.opponent} (${formatScoreLine(teamRecords.highestScore)})`
          });
        }

        if (teamRecords?.biggestWin) {
          cards.push({
            label: "Biggest Win",
            value: formatDiff(teamRecords.biggestWin.pointDiff),
            subtitle: `vs ${teamRecords.biggestWin.opponent} (${formatScoreLine(teamRecords.biggestWin)})`
          });
        }

        if (teamRecords?.toughestLoss) {
          cards.push({
            label: "Toughest Loss",
            value: formatDiff(teamRecords.toughestLoss.pointDiff),
            subtitle: `vs ${teamRecords.toughestLoss.opponent} (${formatScoreLine(teamRecords.toughestLoss)})`
          });
        }

        const totalsEl = document.getElementById("teamTotals");
        totalsEl.innerHTML = "";
        cards.forEach(({ label, value, subtitle, metric }) => {
          const card = document.createElement("article");
          const classes = ["totals-card"];
          if (metric) {
            classes.push("card-clickable");
            card.dataset.metric = metric;
            card.dataset.label = label;
            card.setAttribute("role", "button");
            card.tabIndex = 0;
          }
          card.className = classes.join(" ");
          card.innerHTML = `<span>${label}</span><strong>${value}</strong>${subtitle ? `<p>${subtitle}</p>` : ""}`;
          totalsEl.appendChild(card);
        });
      }

      function formatDateTime(value) {
        if (!value) return null;
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return null;
        return date.toLocaleString([], { dateStyle: "medium", timeStyle: "short" });
      }

      function getTipoffDate(game) {
        if (!game || !game.tipoff) return null;
        const date = new Date(game.tipoff);
        return Number.isNaN(date.getTime()) ? null : date;
      }

      function getTipoffTime(game, fallback = 0) {
        const date = getTipoffDate(game);
        return date ? date.getTime() : fallback;
      }

      function formatScheduleDate(game) {
        const date = getTipoffDate(game);
        if (!date) return game.dateLabel || "TBA";
        return date.toLocaleString([], {
          weekday: "short",
          month: "short",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit"
        });
      }

      function formatCountdown(game) {
        const date = getTipoffDate(game);
        if (!date) return null;
        const diffMs = date.getTime() - Date.now();
        if (diffMs <= 0) return null;
        const diffHours = Math.round(diffMs / 36e5);
        if (diffHours >= 48) {
          const diffDays = Math.round(diffHours / 24);
          return `Starts in ${diffDays} ${diffDays === 1 ? "day" : "days"}`;
        }
        if (diffHours >= 1) {
          return `Starts in ${diffHours} ${diffHours === 1 ? "hour" : "hours"}`;
        }
        const diffMinutes = Math.max(1, Math.round(diffMs / 60000));
        return `Starts in ${diffMinutes} ${diffMinutes === 1 ? "minute" : "minutes"}`;
      }

      function buildGameCard(game, { highlight = false, label = null } = {}) {
        const card = document.createElement("article");
        card.className = highlight ? "game-card game-card--next" : "game-card";
        card.dataset.matchId = game.matchId;

        const headerRow = document.createElement("div");
        headerRow.className = "game-card__header";
        const effectiveLabel = label ?? (highlight ? "Next Game" : null);
        if (effectiveLabel) {
          const labelEl = document.createElement("span");
          labelEl.className = "game-card__label";
          labelEl.textContent = effectiveLabel;
          headerRow.appendChild(labelEl);
        } else {
          headerRow.appendChild(document.createElement("span"));
        }

        const badge = document.createElement("span");
        badge.className = "game-card__homeaway";
        badge.classList.add(game.homeOrAway === "home" ? "is-home" : "is-away");
        badge.textContent = game.homeOrAway === "home" ? "Home" : "Away";
        headerRow.appendChild(badge);
        card.appendChild(headerRow);

        const opponentLine = document.createElement("div");
        opponentLine.className = "game-card__opponent";
        const prefix = game.homeOrAway === "home" ? "vs" : "@";
        opponentLine.textContent = `${prefix} ${game.opponent || "TBD"}`;
        card.appendChild(opponentLine);

        const metaLine = document.createElement("div");
        metaLine.className = "game-card__meta";
        const metaParts = [];
        const formattedDate = formatScheduleDate(game);
        if (formattedDate) metaParts.push(formattedDate);
        if (game.location) metaParts.push(game.location);
        metaLine.textContent = metaParts.join(" • ") || "TBA";
        card.appendChild(metaLine);

        if (highlight) {
          const countdown = formatCountdown(game);
          if (countdown) {
            const countdownEl = document.createElement("div");
            countdownEl.className = "game-card__countdown";
            countdownEl.textContent = countdown;
            card.appendChild(countdownEl);
          }
        }

        const hasScore = Number.isFinite(game.kogScore) && Number.isFinite(game.opponentScore);
        if (hasScore) {
          const scoreRow = document.createElement("div");
          scoreRow.className = "game-card__score";
          scoreRow.innerHTML = `
            <span class="game-card__score-kog">${game.kogScore}</span>
            <span class="game-card__score-sep">-</span>
            <span class="game-card__score-opp">${game.opponentScore}</span>
          `;
          card.appendChild(scoreRow);

          const result = (game.result || "").toLowerCase();
          if (result) {
            const resultRow = document.createElement("div");
            resultRow.className = "game-card__result game-card__result--" + result;
            const diffLabel = Number.isFinite(game.pointDiff) ? formatDiff(game.pointDiff) : "";
            const resultLabel = result === "win" ? "Win" : result === "loss" ? "Loss" : "Draw";
            resultRow.textContent = diffLabel ? `${resultLabel} ${diffLabel}` : resultLabel;
            card.appendChild(resultRow);
          }
        }

        return card;
      }

      function renderSchedule(games) {
        nextGameWrapper.innerHTML = "";
        playedGamesList.innerHTML = "";
        upcomingGamesList.innerHTML = "";

        if (!Array.isArray(games) || !games.length) {
          scheduleSection.hidden = true;
          return;
        }

        scheduleSection.hidden = false;

        const played = games
          .filter((game) => (game.status || "").toLowerCase() === "played")
          .sort((a, b) => getTipoffTime(b, 0) - getTipoffTime(a, 0));

        const upcoming = games
          .filter((game) => (game.status || "").toLowerCase() !== "played")
          .sort((a, b) => getTipoffTime(a, Number.POSITIVE_INFINITY) - getTipoffTime(b, Number.POSITIVE_INFINITY));

        const nextGame = upcoming.length ? upcoming.shift() : null;

        if (nextGame) {
          nextGameWrapper.appendChild(buildGameCard(nextGame, { highlight: true }));
          nextGameWrapper.classList.add("active");
        } else {
          nextGameWrapper.classList.remove("active");
        }

        if (played.length) {
          playedGamesGroup.style.display = "";
          played.forEach((game) => {
            playedGamesList.appendChild(buildGameCard(game, { label: "Final" }));
          });
        } else {
          playedGamesGroup.style.display = "none";
        }

        if (upcoming.length) {
          upcomingGamesGroup.style.display = "";
          upcoming.forEach((game) => {
            upcomingGamesList.appendChild(buildGameCard(game));
          });
        } else {
          upcomingGamesGroup.style.display = "none";
        }
      }

      function renderLinks(links) {
        linksList.innerHTML = "";
        if (!Array.isArray(links) || !links.length) {
          linksCard.hidden = true;
          return;
        }

        links.forEach((link) => {
          if (!link || !link.url) return;
          const anchor = document.createElement("a");
          anchor.href = link.url;
          anchor.target = "_blank";
          anchor.rel = "noreferrer noopener";
          anchor.textContent = link.label || link.url;
          linksList.appendChild(anchor);
        });

        linksCard.hidden = linksList.children.length === 0;
      }

      function renderBadges(players, metadata, gamesCount) {
        metaContainer.innerHTML = "";
        metaContainer.appendChild(createBadge("Games Logged", gamesCount));

        const compareBy = (key) =>
          players
            .slice()
            .sort(
              (a, b) =>
                (b[key] ?? 0) - (a[key] ?? 0) || a.name.localeCompare(b.name)
            )[0];

        const bestScorer = players.length ? compareBy("totalPoints") : null;
        const bestThree = players.length ? compareBy("threePointsMade") : null;
        const topFouler = players.length ? compareBy("foulsMade") : null;

        bestScorer && bestScorer.totalPoints > 0 && metaContainer.appendChild(createBadge("Top Scorer 🪣", bestScorer.name));
        bestThree && bestThree.threePointsMade > 0 && metaContainer.appendChild(createBadge("Top 3PT 👌", bestThree.name));
        topFouler && topFouler.foulsMade > 0 && metaContainer.appendChild(createBadge("Top Fouler 🩼", topFouler.name));

        const updated = formatDateTime(metadata && metadata.generatedAt);
        if (updated) {
          metaContainer.appendChild(createBadge("Updated", updated));
        }
      }

      function renderTable(players) {
        const tbody = document.getElementById("statsTable");
        tbody.innerHTML = "";

        const metrics = [
          "gamesPlayed",
          "freeThrowsMade",
          "fieldGoalsMade",
          "pointsPerGame",
          "totalPoints",
          "threePointsMade",
          "foulsMade",
        ];

        const maxima = metrics.reduce((acc, key) => {
          const values = players.map((p) => Number(p[key]) || 0);
          acc[key] = values.length ? Math.max(...values) : 0;
          return acc;
        }, {});

        players.forEach((player) => {
          const row = document.createElement("tr");
          const pointsPerGame = player.gamesPlayed
            ? (player.totalPoints / player.gamesPlayed).toFixed(1)
            : "0.0";

          const cells = [
            { value: player.gamesPlayed, key: "gamesPlayed", display: player.gamesPlayed },
            { value: player.freeThrowsMade, key: "freeThrowsMade", display: player.freeThrowsMade },
            { value: player.fieldGoalsMade, key: "fieldGoalsMade", display: player.fieldGoalsMade },
            {
              value: parseFloat(pointsPerGame),
              key: "pointsPerGame",
              display: pointsPerGame,
            },
            { value: player.totalPoints, key: "totalPoints", display: player.totalPoints },
            {
              value: player.threePointsMade,
              key: "threePointsMade",
              display: player.threePointsMade,
            },
            { value: player.foulsMade, key: "foulsMade", display: player.foulsMade },
          ];

          row.innerHTML = `
            <td class="number">#${player.number || "-"}</td>
            <td>
              ${player.name}
              <span>${player.gamesPlayed ? "Active" : "DNP"}</span>
            </td>
            ${cells
              .map(({ display }) => `<td>${Number.isFinite(display) ? display : display || 0}</td>`)
              .join("")}
          `;

          const tds = row.querySelectorAll("td");
          cells.forEach(({ value, key }, index) => {
            if (value === maxima[key] && maxima[key] > 0) {
              tds[index + 2].classList.add("highlight");
            }
          });

          row.dataset.name = player.name;
          row.dataset.number = player.number || "-";
          row.dataset.games = player.gamesPlayed;
          row.dataset.freeThrows = player.freeThrowsMade;
          row.dataset.fieldGoals = player.fieldGoalsMade;
          row.dataset.pointsPerGame = pointsPerGame;
          row.dataset.totalPoints = player.totalPoints;
          row.dataset.threePoints = player.threePointsMade;
          row.dataset.fouls = player.foulsMade;

          tbody.appendChild(row);
        });
      }

      function computeTeamTotals(players) {
        return players.reduce(
          (acc, player) => {
            acc.totalPoints += player.totalPoints;
            acc.fieldGoals += player.fieldGoalsMade;
            acc.freeThrows += player.freeThrowsMade;
            acc.threePointers += player.threePointsMade;
            return acc;
          },
          { totalPoints: 0, fieldGoals: 0, freeThrows: 0, threePointers: 0 }
        );
      }

      function resolveGamesCount(players, metadata) {
        if (metadata && Array.isArray(metadata.gamesProcessed) && metadata.gamesProcessed.length) {
          return metadata.gamesProcessed.length;
        }
        const counts = players.map((p) => p.gamesPlayed || 0).filter((num) => num > 0);
        return counts.length ? Math.max(...counts) : 0;
      }

      Promise.all([
        fetch("data/kog_players.json", { cache: "no-store" })
          .then((response) => (response.ok ? response.json() : []))
          .catch(() => []),
        fetch("data/last_updated.json", { cache: "no-store" })
          .then((response) => (response.ok ? response.json() : null))
          .catch(() => null),
        fetch("data/kog_schedule.json", { cache: "no-store" })
          .then((response) => (response.ok ? response.json() : []))
          .catch(() => []),
        fetch("data/kog_links.json", { cache: "no-store" })
          .then((response) => (response.ok ? response.json() : []))
          .catch(() => [])
      ])
        .then(([playersData, metadata, scheduleData, linksData]) => {
          const players = Array.isArray(playersData) ? playersData : [];
          const gamesCount = resolveGamesCount(players, metadata);
          const playersTracked = metadata && typeof metadata.playersTracked === "number"
            ? metadata.playersTracked
            : players.length;

          playerStore = players;

          renderBadges(players, metadata, gamesCount);
          renderSchedule(Array.isArray(scheduleData) ? scheduleData : []);
          renderLinks(Array.isArray(linksData) ? linksData : []);

          if (!players.length) {
            document.getElementById("noDataMessage").style.display = "block";
            return;
          }

          renderTable(players);
          renderTotals(
            computeTeamTotals(players),
            gamesCount,
            playersTracked,
            metadata?.teamRecords || null
          );
        })
        .catch(() => {
          document.getElementById("noDataMessage").style.display = "block";
          renderBadges([], null, 0);
          renderSchedule([]);
          renderLinks([]);
        });

      function openPlayerModal(data) {
        modalName.textContent = data.name;

        modalBadges.innerHTML = "";
        if (data.number && data.number !== "-") {
          modalBadges.appendChild(createBadge("Jersey", `#${data.number}`));
        }
        modalBadges.appendChild(createBadge("Total Pts", data.totalPoints, "badge--hero"));
        modalBadges.appendChild(createBadge("PTS/G", data.pointsPerGame, "badge--hero"));

        const statConfig = [
          { label: "Games Played", value: data.games },
          { label: "Free Throws Made", value: data.freeThrows },
          { label: "Field Goals Made", value: data.fieldGoals },
          { label: "Three Pointers", value: data.threePoints },
          { label: "Fouls Committed", value: data.fouls }
        ];

        modalStats.innerHTML = "";
        statConfig.forEach(({ label, value }) => {
          const row = document.createElement("div");
          row.className = "stat-row";
          row.innerHTML = `<span>${label}</span><strong>${value}</strong>`;
          modalStats.appendChild(row);
        });

        modalOverlay.classList.add("visible");
        modalOverlay.setAttribute("aria-hidden", "false");
      }

      function openTeamModal(metric, title) {
        const players = playerStore
          .filter((player) => (player[metric] ?? 0) > 0)
          .sort((a, b) => (b[metric] ?? 0) - (a[metric] ?? 0));

        modalName.textContent = title;
        modalBadges.innerHTML = "";

        const totalValue = players.reduce((acc, player) => acc + (player[metric] ?? 0), 0);
        modalBadges.appendChild(createBadge("Team Total", totalValue, "badge--hero"));

        modalStats.innerHTML = "";
        if (!players.length) {
          const emptyRow = document.createElement("div");
          emptyRow.className = "stat-row";
          emptyRow.innerHTML = `<span>No data yet</span><strong>0</strong>`;
          modalStats.appendChild(emptyRow);
        } else {
          players.forEach((player) => {
            const value = player[metric] ?? 0;
            const row = document.createElement("div");
            row.className = "stat-row interactive";
            row.dataset.name = player.name;
            row.dataset.number = player.number || "-";
            row.dataset.games = player.gamesPlayed;
            row.dataset.freeThrows = player.freeThrowsMade;
            row.dataset.fieldGoals = player.fieldGoalsMade;
            row.dataset.pointsPerGame = player.pointsPerGame;
            row.dataset.totalPoints = player.totalPoints;
            row.dataset.threePoints = player.threePointsMade;
            row.dataset.fouls = player.foulsMade;
            row.innerHTML = `<span>${player.name}</span><strong>${value}</strong>`;
            row.addEventListener("click", () => openPlayerModal(row.dataset));
            modalStats.appendChild(row);
          });
        }

        modalOverlay.classList.add("visible");
        modalOverlay.setAttribute("aria-hidden", "false");
      }

      function closeModal() {
        modalOverlay.classList.remove("visible");
        modalOverlay.setAttribute("aria-hidden", "true");
      }

      document.getElementById("statsTable").addEventListener("click", (event) => {
        const row = event.target.closest("tr");
        if (!row) return;
        openPlayerModal(row.dataset);
      });

      const teamTotalsEl = document.getElementById("teamTotals");
      const handleTotalsActivation = (card) => {
        if (!card) return;
        const metric = card.dataset.metric;
        if (!metric) return;
        const label = card.dataset.label || "Team Stat";
        openTeamModal(metric, `${label} Breakdown`);
      };

      teamTotalsEl.addEventListener("click", (event) => {
        const card = event.target.closest(".card-clickable");
        handleTotalsActivation(card);
      });

      teamTotalsEl.addEventListener("keydown", (event) => {
        if (event.key === "Enter" || event.key === " ") {
          const card = event.target.closest(".card-clickable");
          if (!card) return;
          event.preventDefault();
          handleTotalsActivation(card);
        }
      });

      closeModalBtn.addEventListener("click", closeModal);
      modalOverlay.addEventListener("click", (event) => {
        if (event.target === modalOverlay) {
          closeModal();
        }
      });
      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape" && modalOverlay.classList.contains("visible")) {
          closeModal();
        }
      });
    </script>
  </body>
</html>
