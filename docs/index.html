<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>KOG Player Stats</title>
    <style>
      :root {
        color-scheme: dark;
        --bg-gradient: radial-gradient(circle at top, #151a33 0%, #05070e 55%, #010103 100%);
        --card-bg: rgba(12, 16, 34, 0.75);
        --card-border: rgba(82, 93, 150, 0.35);
        --glow: 0 24px 60px rgba(16, 26, 67, 0.55);
        --accent: #46c2ff;
        --accent-soft: rgba(70, 194, 255, 0.18);
        --text-primary: #f3f6ff;
        --text-muted: #9aa4c7;
        --divider: rgba(90, 105, 158, 0.35);
        --badge-bg: rgba(70, 194, 255, 0.12);
        --badge-text: #7fd6ff;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: "Inter", system-ui, -apple-system, Segoe UI, sans-serif;
        background: var(--bg-gradient);
        color: var(--text-primary);
        padding: clamp(1.6rem, 4vw, 3.5rem);
        display: flex;
        justify-content: center;
      }

      main {
        width: min(1100px, 100%);
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 28px;
        box-shadow: var(--glow);
        backdrop-filter: blur(20px);
        padding: clamp(1.6rem, 3vw, 3rem);
        position: relative;
        overflow: hidden;
      }

      main::before {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        background: radial-gradient(circle at 25% 15%, rgba(70, 194, 255, 0.22), transparent 55%),
          radial-gradient(circle at 80% 0%, rgba(125, 214, 255, 0.12), transparent 60%);
        filter: blur(0.5px);
      }

      header {
        position: relative;
        z-index: 1;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 1.5rem;
        margin-bottom: clamp(1.8rem, 3vw, 2.8rem);
      }

      .team-lockup {
        display: grid;
        gap: 0.45rem;
      }

      .team-lockup h1 {
        font-size: clamp(2.1rem, 4vw, 2.9rem);
        letter-spacing: 0.04em;
        text-transform: uppercase;
        margin: 0;
      }

      .team-lockup span {
        font-size: 0.95rem;
        text-transform: uppercase;
        letter-spacing: 0.4em;
        color: var(--text-muted);
      }

      .meta {
        display: flex;
        flex-wrap: wrap;
        gap: 0.7rem;
        z-index: 1;
      }

      .badge {
        padding: 0.45rem 0.85rem;
        border-radius: 999px;
        border: 1px solid var(--accent-soft);
        background: var(--badge-bg);
        color: var(--badge-text);
        font-size: 0.8rem;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        letter-spacing: 0.08em;
      }

      .badge strong {
        font-weight: 600;
        color: var(--text-primary);
      }

      section {
        position: relative;
        z-index: 1;
      }

      .table-wrapper {
        overflow-x: auto;
        border-radius: 20px;
        border: 1px solid rgba(96, 108, 162, 0.25);
        background: rgba(7, 10, 22, 0.65);
        box-shadow: inset 0 1px 0 rgba(108, 124, 182, 0.25);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 720px;
      }

      thead {
        background: linear-gradient(95deg, rgba(70, 194, 255, 0.18), rgba(70, 194, 255, 0.05));
      }

      th,
      td {
        padding: 1rem 1.25rem;
        text-align: right;
        font-size: 0.92rem;
      }

      th {
        text-transform: uppercase;
        letter-spacing: 0.2em;
        font-size: 0.72rem;
        color: var(--text-muted);
        font-weight: 600;
      }

      th:first-child,
      td:first-child,
      th:nth-child(2),
      td:nth-child(2) {
        text-align: left;
      }

      tbody tr {
        border-bottom: 1px solid var(--divider);
        transition: background 180ms ease, transform 180ms ease;
      }

      tbody tr:last-child {
        border-bottom: none;
      }

      tbody tr:hover {
        background: rgba(70, 194, 255, 0.06);
        transform: translateY(-2px);
      }

      tbody td {
        color: var(--text-primary);
      }

      tbody td span {
        display: block;
        color: var(--text-muted);
        font-size: 0.78rem;
        letter-spacing: 0.02em;
      }

      .number {
        font-weight: 600;
        color: var(--accent);
      }

      .highlight {
        color: #f8d057;
        font-weight: 600;
        text-shadow: 0 0 16px rgba(255, 210, 95, 0.45);
      }

      .totals {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 1rem;
        margin-bottom: 1.8rem;
        position: relative;
        z-index: 1;
      }

      .totals-card {
        border: 1px solid rgba(96, 108, 162, 0.22);
        background: rgba(9, 12, 26, 0.65);
        border-radius: 18px;
        padding: 1rem 1.2rem;
        display: grid;
        gap: 0.35rem;
      }

      .totals-card span {
        color: var(--text-muted);
        font-size: 0.8rem;
        letter-spacing: 0.16em;
        text-transform: uppercase;
      }

      .totals-card strong {
        font-size: 1.6rem;
        font-weight: 600;
        letter-spacing: 0.04em;
      }

      .totals-card p {
        margin: 0;
        color: var(--text-muted);
        font-size: 0.78rem;
        letter-spacing: 0.04em;
      }

      .no-data {
        margin-top: 1.6rem;
        padding: 1.1rem 1.3rem;
        border-radius: 14px;
        border: 1px dashed rgba(70, 194, 255, 0.42);
        background: rgba(4, 7, 18, 0.65);
        color: var(--badge-text);
        font-size: 0.88rem;
        display: none;
      }

      @media (max-width: 768px) {
        main {
          border-radius: 22px;
        }

        header {
          flex-direction: column;
          align-items: flex-start;
        }

        thead {
          position: sticky;
          top: 0;
        }
      }

      @media (max-width: 640px) {
        body {
          padding: 1.2rem;
        }

        th,
        td {
          padding: 0.7rem 0.85rem;
          font-size: 0.84rem;
        }

        th {
          font-size: 0.66rem;
          letter-spacing: 0.16em;
        }

        tbody td span {
          font-size: 0.7rem;
        }

        .badge {
          font-size: 0.7rem;
          letter-spacing: 0.06em;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <header></header>

      <section class="totals" id="teamTotals"></section>

      <section>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>No.</th>
                <th>Player</th>
                <th>Games</th>
                <th>FT Made</th>
                <th>FG Made</th>
                <th>P/G</th>
                <th>Total Pts</th>
                <th>3PT Made</th>
                <th>Fouls</th>
              </tr>
            </thead>
            <tbody id="statsTable"></tbody>
          </table>
        </div>
        <div class="no-data" id="noDataMessage">
          No stats available yet. Check back after the next Kungsholmen OG game tip-off.
        </div>
      </section>
    </main>

    <script>
      const header = document.querySelector("header");
      const metaContainer = document.createElement("div");
      metaContainer.className = "meta";
      header.appendChild(
        (() => {
          const lockup = document.createElement("div");
          lockup.className = "team-lockup";
          lockup.innerHTML = `
            <span>Season 2025</span>
            <h1>Kungsholmen OG</h1>
          `;
          return lockup;
        })()
      );
      header.appendChild(metaContainer);

      function createBadge(label, value) {
        const badge = document.createElement("span");
        badge.className = "badge";
        badge.innerHTML = `<strong>${value}</strong>${label}`;
        return badge;
      }

      function formatDiff(diff) {
        if (diff > 0) return `+${diff}`;
        if (diff < 0) return `${diff}`;
        return `${diff}`;
      }

      const formatScoreLine = (record) => `${record.kogPoints}-${record.opponentPoints}`;

      function renderTotals(totals, gamesCount, playersTracked, teamRecords) {
        const cards = [
          { label: "Team Points", value: totals.totalPoints },
          { label: "Team Field Goals", value: totals.fieldGoals },
          { label: "Team Free Throws", value: totals.freeThrows },
          { label: "Games Logged", value: gamesCount },
          { label: "Players Tracked", value: playersTracked }
        ];

        if (teamRecords?.highestScore) {
          cards.push({
            label: "Highest Score",
            value: teamRecords.highestScore.kogPoints,
            subtitle: `vs ${teamRecords.highestScore.opponent} (${formatScoreLine(teamRecords.highestScore)})`
          });
        }

        if (teamRecords?.biggestWin) {
          cards.push({
            label: "Biggest Win",
            value: formatDiff(teamRecords.biggestWin.pointDiff),
            subtitle: `vs ${teamRecords.biggestWin.opponent} (${formatScoreLine(teamRecords.biggestWin)})`
          });
        }

        if (teamRecords?.toughestLoss) {
          cards.push({
            label: "Toughest Loss",
            value: formatDiff(teamRecords.toughestLoss.pointDiff),
            subtitle: `vs ${teamRecords.toughestLoss.opponent} (${formatScoreLine(teamRecords.toughestLoss)})`
          });
        }

        const totalsEl = document.getElementById("teamTotals");
        totalsEl.innerHTML = "";
        cards.forEach(({ label, value, subtitle }) => {
          const card = document.createElement("article");
          card.className = "totals-card";
          card.innerHTML = `<span>${label}</span><strong>${value}</strong>${subtitle ? `<p>${subtitle}</p>` : ""}`;
          totalsEl.appendChild(card);
        });
      }

      function formatDateTime(value) {
        if (!value) return null;
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return null;
        return date.toLocaleString([], { dateStyle: "medium", timeStyle: "short" });
      }

      function renderBadges(players, metadata, gamesCount) {
        metaContainer.innerHTML = "";
        metaContainer.appendChild(createBadge("Games Logged", gamesCount));

        const compareBy = (key) =>
          players
            .slice()
            .sort(
              (a, b) =>
                (b[key] ?? 0) - (a[key] ?? 0) || a.name.localeCompare(b.name)
            )[0];

        const bestScorer = players.length ? compareBy("totalPoints") : null;
        const bestThree = players.length ? compareBy("threePointsMade") : null;
        const topFouler = players.length ? compareBy("foulsMade") : null;

        bestScorer && bestScorer.totalPoints > 0 && metaContainer.appendChild(createBadge("Top Scorer", bestScorer.name));
        bestThree && bestThree.threePointsMade > 0 && metaContainer.appendChild(createBadge("Top 3PT", bestThree.name));
        topFouler && topFouler.foulsMade > 0 && metaContainer.appendChild(createBadge("Top Fouler", topFouler.name));

        const updated = formatDateTime(metadata && metadata.generatedAt);
        if (updated) {
          metaContainer.appendChild(createBadge("Updated", updated));
        }
      }

      function renderTable(players) {
        const tbody = document.getElementById("statsTable");
        tbody.innerHTML = "";

        const metrics = [
          "gamesPlayed",
          "freeThrowsMade",
          "fieldGoalsMade",
          "pointsPerGame",
          "totalPoints",
          "threePointsMade",
          "foulsMade",
        ];

        const maxima = metrics.reduce((acc, key) => {
          const values = players.map((p) => Number(p[key]) || 0);
          acc[key] = values.length ? Math.max(...values) : 0;
          return acc;
        }, {});

        players.forEach((player) => {
          const row = document.createElement("tr");
          const pointsPerGame = player.gamesPlayed
            ? (player.totalPoints / player.gamesPlayed).toFixed(1)
            : "0.0";

          const cells = [
            { value: player.gamesPlayed, key: "gamesPlayed", display: player.gamesPlayed },
            { value: player.freeThrowsMade, key: "freeThrowsMade", display: player.freeThrowsMade },
            { value: player.fieldGoalsMade, key: "fieldGoalsMade", display: player.fieldGoalsMade },
            {
              value: parseFloat(pointsPerGame),
              key: "pointsPerGame",
              display: pointsPerGame,
            },
            { value: player.totalPoints, key: "totalPoints", display: player.totalPoints },
            {
              value: player.threePointsMade,
              key: "threePointsMade",
              display: player.threePointsMade,
            },
            { value: player.foulsMade, key: "foulsMade", display: player.foulsMade },
          ];

          row.innerHTML = `
            <td class="number">#${player.number || "-"}</td>
            <td>
              ${player.name}
              <span>${player.gamesPlayed ? "Active" : "DNP"}</span>
            </td>
            ${cells
              .map(({ display }) => `<td>${Number.isFinite(display) ? display : display || 0}</td>`)
              .join("")}
          `;

          const tds = row.querySelectorAll("td");
          cells.forEach(({ value, key }, index) => {
            if (value === maxima[key] && maxima[key] > 0) {
              tds[index + 2].classList.add("highlight");
            }
          });

          tbody.appendChild(row);
        });
      }

      function computeTeamTotals(players) {
        return players.reduce(
          (acc, player) => {
            acc.totalPoints += player.totalPoints;
            acc.fieldGoals += player.fieldGoalsMade;
            acc.freeThrows += player.freeThrowsMade;
            return acc;
          },
          { totalPoints: 0, fieldGoals: 0, freeThrows: 0 }
        );
      }

      function resolveGamesCount(players, metadata) {
        if (metadata && Array.isArray(metadata.gamesProcessed) && metadata.gamesProcessed.length) {
          return metadata.gamesProcessed.length;
        }
        const counts = players.map((p) => p.gamesPlayed || 0).filter((num) => num > 0);
        return counts.length ? Math.max(...counts) : 0;
      }

      Promise.all([
        fetch("data/kog_players.json", { cache: "no-store" })
          .then((response) => (response.ok ? response.json() : []))
          .catch(() => []),
        fetch("data/last_updated.json", { cache: "no-store" })
          .then((response) => (response.ok ? response.json() : null))
          .catch(() => null)
      ])
        .then(([playersData, metadata]) => {
          const players = Array.isArray(playersData) ? playersData : [];
          const gamesCount = resolveGamesCount(players, metadata);
          const playersTracked = metadata && typeof metadata.playersTracked === "number"
            ? metadata.playersTracked
            : players.length;

          renderBadges(players, metadata, gamesCount);

          if (!players.length) {
            document.getElementById("noDataMessage").style.display = "block";
            return;
          }

          renderTable(players);
          renderTotals(
            computeTeamTotals(players),
            gamesCount,
            playersTracked,
            metadata?.teamRecords || null
          );
        })
        .catch(() => {
          document.getElementById("noDataMessage").style.display = "block";
          renderBadges([], null, 0);
        });
    </script>
  </body>
</html>
